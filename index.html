<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stream Viewer</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --bg: #0d1117;
        --surface: #161b22;
        --border: #30363d;
        --text: #e6edf3;
        --text-dim: #7d8590;
        --green: #3fb950;
        --red: #f85149;
        --yellow: #d29922;
        --blue: #58a6ff;
      }

      body {
        background: var(--bg);
        color: var(--text);
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial,
          sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 20px;
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
      }

      .header h1 {
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        background: var(--text-dim);
        transition: background 0.3s;
      }
      .status-dot.streaming {
        background: var(--green);
        box-shadow: 0 0 8px var(--green);
      }
      .status-dot.scanning,
      .status-dot.connecting {
        background: var(--yellow);
        animation: pulse 1s infinite;
      }
      .status-dot.error {
        background: var(--red);
        animation: pulse 0.5s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }

      .header-info {
        display: flex;
        gap: 20px;
        font-size: 13px;
        color: var(--text-dim);
      }

      .header-info span {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .header-info .val {
        color: var(--text);
        font-variant-numeric: tabular-nums;
      }

      /* â”€â”€â”€ Stream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .stream-wrap {
        flex: 1;
        position: relative;
        overflow: hidden;
      }

      #stream {
        border-radius: 0;
        background: #000;
        display: block;
      }

      /* Ğ ĞµĞ¶Ğ¸Ğ¼Ñ‹ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ */
      .view-fit #stream {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: fill; /* Ğ´ĞµÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ğ¾Ğ´ ÑĞºÑ€Ğ°Ğ½ */
      }
      .view-fill #stream {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover; /* Ğ¾Ğ±Ñ€ĞµĞ·Ğ°ĞµÑ‚ ĞºÑ€Ğ°Ñ, Ğ±ĞµĞ· Ğ¿Ğ¾Ğ»Ğ¾Ñ */
      }
      .view-contain #stream {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain; /* Ñ‡Ñ‘Ñ€Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ğ¾ÑÑ‹, Ğ±ĞµĞ· Ğ´ĞµÑ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ */
      }
      .view-original #stream {
        position: static;
        width: auto;
        height: auto;
        max-width: none;
        max-height: none;
        object-fit: none; /* 1:1 Ğ¿Ğ¸ĞºÑĞµĞ»Ğ¸ */
      }

      /* â”€â”€â”€ Overlay (ĞºĞ¾Ğ³Ğ´Ğ° Ğ½ĞµÑ‚ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ°) â”€â”€â”€â”€â”€â”€â”€â”€ */
      .overlay {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(13, 17, 23, 0.92);
        z-index: 10;
        transition: opacity 0.4s;
        pointer-events: none;
      }
      .overlay.hidden {
        opacity: 0;
      }

      .overlay-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }

      .overlay h2 {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .overlay p {
        color: var(--text-dim);
        font-size: 14px;
        text-align: center;
        max-width: 400px;
        line-height: 1.5;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border);
        border-top-color: var(--blue);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-bottom: 16px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* â”€â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .footer {
        padding: 8px 20px;
        background: var(--surface);
        border-top: 1px solid var(--border);
        font-size: 12px;
        color: var(--text-dim);
        display: flex;
        justify-content: space-between;
        flex-shrink: 0;
      }

      .footer a {
        color: var(--blue);
        text-decoration: none;
      }

      /* â”€â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .controls {
        display: flex;
        gap: 8px;
      }

      .btn {
        background: var(--surface);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 5px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        transition: background 0.2s;
      }
      .btn:hover {
        background: var(--border);
      }

      /* â”€â”€â”€ Log panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .log-panel {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s;
        background: var(--surface);
        border-top: 1px solid var(--border);
      }
      .log-panel.open {
        max-height: 200px;
      }

      .log-content {
        padding: 10px 20px;
        font-family: "Cascadia Code", "Fira Code", monospace;
        font-size: 12px;
        color: var(--text-dim);
        overflow-y: auto;
        max-height: 180px;
        line-height: 1.6;
      }

      .log-content .log-error {
        color: var(--red);
      }
      .log-content .log-ok {
        color: var(--green);
      }
      .log-content .log-warn {
        color: var(--yellow);
      }

      /* â”€â”€â”€ Alarm panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .alarm-panel {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s;
        background: var(--surface);
        border-top: 1px solid var(--border);
      }
      .alarm-panel.open {
        max-height: 400px;
      }

      .alarm-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 20px;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
      }
      .alarm-header .alarm-badge {
        background: var(--red);
        color: #fff;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
      }

      .alarm-list {
        padding: 0;
        margin: 0;
        list-style: none;
        overflow-y: auto;
        max-height: 350px;
      }

      .alarm-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 20px;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
        cursor: pointer;
        transition: background 0.15s;
      }
      .alarm-item:hover {
        background: rgba(88, 166, 255, 0.08);
      }

      .alarm-thumb {
        width: 80px;
        height: 60px;
        border-radius: 4px;
        object-fit: cover;
        background: #000;
        border: 1px solid var(--border);
        flex-shrink: 0;
      }

      .alarm-info {
        flex: 1;
        min-width: 0;
      }
      .alarm-info .alarm-type {
        font-weight: 600;
        color: var(--red);
      }
      .alarm-info .alarm-time {
        color: var(--text-dim);
        font-size: 12px;
      }
      .alarm-info .alarm-file {
        color: var(--text-dim);
        font-size: 11px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .alarm-empty {
        padding: 30px 20px;
        text-align: center;
        color: var(--text-dim);
        font-size: 13px;
      }

      /* â”€â”€â”€ Alarm photo modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .alarm-modal {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 100;
        background: rgba(0, 0, 0, 0.85);
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .alarm-modal.show {
        display: flex;
      }
      .alarm-modal img {
        max-width: 90vw;
        max-height: 90vh;
        border-radius: 8px;
        border: 2px solid var(--border);
      }
      .alarm-modal-info {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--surface);
        padding: 8px 20px;
        border-radius: 8px;
        font-size: 13px;
        color: var(--text);
        border: 1px solid var(--border);
      }

      /* â”€â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      @media (max-width: 600px) {
        .header {
          flex-direction: column;
          gap: 8px;
        }
        .header-info {
          gap: 12px;
          font-size: 12px;
          flex-wrap: wrap;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>
        <span class="status-dot" id="statusDot"></span>
        <span>Stream Viewer</span>
        <span
          id="statusText"
          style="font-weight: 400; font-size: 13px; color: var(--text-dim)"
        ></span>
      </h1>
      <div class="header-info">
        <span>IP: <b class="val" id="camIp">â€”</b></span>
        <span>FPS: <b class="val" id="camFps">â€”</b></span>
        <span>Ğ Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ: <b class="val" id="camRes">â€”</b></span>
        <span>ĞĞ¿Ñ‚Ğ°Ğ¹Ğ¼: <b class="val" id="camUptime">â€”</b></span>
        <span>ĞšĞ°Ğ´Ñ€Ğ¾Ğ²: <b class="val" id="camFrames">â€”</b></span>
      </div>
      <div class="controls">
        <button
          class="btn"
          onclick="takeSnapshot()"
          title="Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ĞºĞ°Ğ´Ñ€"
        >
          ğŸ“· Ğ¡Ğ½Ğ¸Ğ¼Ğ¾Ğº
        </button>
        <button class="btn" onclick="toggleFullscreen()" title="ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ ÑĞºÑ€Ğ°Ğ½">
          â›¶ Ğ­ĞºÑ€Ğ°Ğ½
        </button>
        <button class="btn" onclick="toggleLog()" title="ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ»Ğ¾Ğ³">
          ğŸ“‹ Ğ›Ğ¾Ğ³
        </button>
        <button
          class="btn"
          onclick="toggleAlarms()"
          title="Ğ¢Ñ€ĞµĞ²Ğ¾Ğ³Ğ¸"
          id="alarmBtn"
        >
          ğŸš¨ Ğ¢Ñ€ĞµĞ²Ğ¾Ğ³Ğ¸
        </button>
        <select
          class="btn"
          id="viewMode"
          onchange="setViewMode(this.value)"
          title="Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ"
        >
          <option value="fit" selected>â†” Ğ’Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ</option>
          <option value="contain">ğŸ”² ĞŸÑ€Ğ¾Ğ¿Ğ¾Ñ€Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾</option>
          <option value="fill">ğŸ”³ Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ</option>
          <option value="original">ğŸ” ĞÑ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»</option>
        </select>
        <select
          class="btn"
          id="camMode"
          onchange="setCamMode(this.value)"
          title="ĞšĞ°Ğ´Ñ€: Ğ²ÑĞµ/Ğ²ĞµÑ€Ñ…/Ğ½Ğ¸Ğ·"
        >
          <option value="full" selected>ğŸ“· Ğ’ĞµÑÑŒ ĞºĞ°Ğ´Ñ€</option>
          <option value="top">â¬† Ğ’ĞµÑ€Ñ… (ĞºĞ°Ğ¼ĞµÑ€Ğ° Ğ²ĞµÑ€Ñ…)</option>
          <option value="bottom">â¬‡ ĞĞ¸Ğ· (ĞºĞ°Ğ¼ĞµÑ€Ğ° Ğ½Ğ¸Ğ·)</option>
        </select>
      </div>
    </div>

    <div class="stream-wrap view-fit" id="streamWrap">
      <img id="stream" alt="Camera stream" />
      <div class="overlay" id="overlay">
        <div class="spinner" id="overlaySpinner"></div>
        <h2 id="overlayTitle">ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ...</h2>
        <p id="overlayText">ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ° Ñ ĞºĞ°Ğ¼ĞµÑ€Ñ‹</p>
      </div>
    </div>

    <div class="log-panel" id="logPanel">
      <div class="log-content" id="logContent"></div>
    </div>

    <div class="alarm-panel" id="alarmPanel">
      <div class="alarm-header">
        <span
          >ğŸš¨ Ğ¢Ñ€ĞµĞ²Ğ¾Ğ³Ğ¸ <span class="alarm-badge" id="alarmCount">0</span></span
        >
        <span
          id="alarmLastCheck"
          style="color: var(--text-dim); font-size: 12px"
          >â€”</span
        >
      </div>
      <ul class="alarm-list" id="alarmList">
        <li class="alarm-empty">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</li>
      </ul>
    </div>

    <!-- ĞœĞ¾Ğ´Ğ°Ğ» Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ñ„Ğ¾Ñ‚Ğ¾ Ñ‚Ñ€ĞµĞ²Ğ¾Ğ³Ğ¸ -->
    <div class="alarm-modal" id="alarmModal" onclick="closeAlarmModal()">
      <img id="alarmModalImg" onclick="event.stopPropagation()" />
      <div
        class="alarm-modal-info"
        id="alarmModalInfo"
        onclick="event.stopPropagation()"
      ></div>
    </div>

    <div class="footer">
      <span id="footerStatus">Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ...</span>
      <span
        >Stream Viewer v1.1 Â· <a href="/status" target="_blank">/status</a> Â·
        <a href="/snapshot" target="_blank">/snapshot</a> Â·
        <a href="/alarms" target="_blank">/alarms</a></span
      >
    </div>

    <script>
      // â”€â”€â”€ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const STATUS_POLL_MS = 2000; // ĞĞ¿Ñ€Ğ¾Ñ /status
      const STREAM_RECONNECT_MS = 5000; // Ğ—Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ°
      const MAX_LOG = 100; // ĞœĞ°ĞºÑ ÑÑ‚Ñ€Ğ¾Ğº Ğ² Ğ»Ğ¾Ğ³Ğµ

      // â”€â”€â”€ Ğ­Ğ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const streamImg = document.getElementById("stream");
      const overlay = document.getElementById("overlay");
      const overlayTitle = document.getElementById("overlayTitle");
      const overlayText = document.getElementById("overlayText");
      const overlaySpinner = document.getElementById("overlaySpinner");
      const statusDot = document.getElementById("statusDot");
      const statusText = document.getElementById("statusText");
      const camIp = document.getElementById("camIp");
      const camFps = document.getElementById("camFps");
      const camRes = document.getElementById("camRes");
      const camUptime = document.getElementById("camUptime");
      const camFrames = document.getElementById("camFrames");
      const footerStatus = document.getElementById("footerStatus");
      const logContent = document.getElementById("logContent");
      const logPanel = document.getElementById("logPanel");

      let lastStatus = "init";
      let streamConnected = false;
      let reconnectTimer = null;
      let currentCamMode = "full";

      // â”€â”€â”€ Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function addLog(msg, level = "") {
        const time = new Date().toLocaleTimeString("ru-RU");
        const cls =
          level === "error"
            ? "log-error"
            : level === "ok"
              ? "log-ok"
              : level === "warn"
                ? "log-warn"
                : "";
        const div = document.createElement("div");
        div.className = cls;
        div.textContent = `[${time}] ${msg}`;
        logContent.appendChild(div);
        // ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼
        while (logContent.children.length > MAX_LOG) {
          logContent.removeChild(logContent.firstChild);
        }
        logContent.scrollTop = logContent.scrollHeight;
      }

      // â”€â”€â”€ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function formatUptime(seconds) {
        if (!seconds) return "â€”";
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        return `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
      }

      async function pollStatus() {
        try {
          const resp = await fetch("/status", {
            signal: AbortSignal.timeout(3000),
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();

          // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ UI
          statusDot.className = "status-dot " + data.status;
          camIp.textContent = data.camera_ip || "â€”";
          camFps.textContent = data.fps > 0 ? data.fps : "â€”";
          camRes.textContent = data.resolution || "â€”";
          camUptime.textContent = formatUptime(data.uptime_seconds);
          camFrames.textContent =
            data.frame_count > 0 ? data.frame_count.toLocaleString() : "â€”";

          const statusLabels = {
            init: "Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ",
            scanning: "ĞŸĞ¾Ğ¸ÑĞº ĞºĞ°Ğ¼ĞµÑ€Ñ‹...",
            connecting: "ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ...",
            streaming: "Ğ¢Ñ€Ğ°Ğ½ÑĞ»ÑÑ†Ğ¸Ñ",
            error: "ĞÑˆĞ¸Ğ±ĞºĞ°",
          };
          statusText.textContent =
            "Â· " + (statusLabels[data.status] || data.status);
          footerStatus.textContent =
            data.status === "streaming"
              ? `Ğ¢Ñ€Ğ°Ğ½ÑĞ»ÑÑ†Ğ¸Ñ Â· ${data.camera_ip} Â· ${data.resolution} Â· ${data.fps} fps`
              : data.error || statusLabels[data.status] || data.status;

          // Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¼ĞµĞ½Ñƒ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
          if (data.status !== lastStatus) {
            if (data.status === "streaming") {
              addLog(`Ğ¢Ñ€Ğ°Ğ½ÑĞ»ÑÑ†Ğ¸Ñ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ° (${data.camera_ip})`, "ok");
            } else if (data.status === "error") {
              addLog(`ĞÑˆĞ¸Ğ±ĞºĞ°: ${data.error}`, "error");
            } else if (data.status === "scanning") {
              addLog("ĞŸĞ¾Ğ¸ÑĞº ĞºĞ°Ğ¼ĞµÑ€Ñ‹ Ğ² ÑĞµÑ‚Ğ¸...", "warn");
            } else if (data.status === "connecting") {
              addLog(`ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº ${data.camera_ip}...`);
            }
            lastStatus = data.status;
          }

          // Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ¼ (Ğ½Ğµ ÑĞ¿Ğ°Ğ¼Ğ¸Ğ¼ ĞµÑĞ»Ğ¸ ÑƒĞ¶Ğµ Ğ¿Ñ‹Ñ‚Ğ°ĞµĞ¼ÑÑ)
          if (
            data.status === "streaming" &&
            !streamConnected &&
            !streamStarting &&
            !reconnectTimer
          ) {
            startStream();
          }

          // ĞĞ²ĞµÑ€Ğ»ĞµĞ¹
          updateOverlay(data);
        } catch (e) {
          statusDot.className = "status-dot error";
          statusText.textContent = "Â· Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½";
          footerStatus.textContent =
            "Ğ‘ÑĞºĞµĞ½Ğ´ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ â€” Ğ°Ğ²Ñ‚Ğ¾Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ...";
          updateOverlay({ status: "backend_down" });
          addLog("Ğ‘ÑĞºĞµĞ½Ğ´ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½, Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ°...", "error");
        }
      }

      function updateOverlay(data) {
        if (data.status === "streaming" && streamConnected) {
          overlay.classList.add("hidden");
          return;
        }
        overlay.classList.remove("hidden");

        const messages = {
          init: ["â³", "Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ", "Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±ÑĞºĞµĞ½Ğ´Ğ°..."],
          scanning: ["ğŸ“¡", "ĞŸĞ¾Ğ¸ÑĞº ĞºĞ°Ğ¼ĞµÑ€Ñ‹", "Ğ¡ĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑĞµÑ‚Ğ¸..."],
          connecting: [
            "ğŸ”Œ",
            "ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ",
            `Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° RTSP-ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ Ñ ${data.camera_ip || ""}...`,
          ],
          streaming: ["ğŸ“º", "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ°", "ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ°Ğ´Ñ€Ğ°..."],
          error: [
            "âš ï¸",
            "ĞÑˆĞ¸Ğ±ĞºĞ°",
            `${data.error || "ĞĞµÑ‚ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ"}. ĞĞ²Ñ‚Ğ¾Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ...`,
          ],
          backend_down: [
            "ğŸ”´",
            "Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½",
            "Ğ‘ÑĞºĞµĞ½Ğ´ Ğ½Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚. ĞŸĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 2 ÑĞµĞº...",
          ],
        };

        const [icon, title, text] = messages[data.status] || [
          "â“",
          data.status,
          "",
        ];
        overlaySpinner.style.display =
          data.status === "error" || data.status === "backend_down"
            ? "none"
            : "block";
        overlayTitle.textContent = `${icon} ${title}`;
        overlayText.textContent = text;
      }

      // â”€â”€â”€ MJPEG Ğ¿Ğ¾Ñ‚Ğ¾Ğº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let streamStarting = false;

      function startStream() {
        if (streamStarting) return; // Ğ½Ğµ ÑĞ¿Ğ°Ğ¼Ğ¸Ñ‚ÑŒ
        streamStarting = true;

        const url = `/stream?cam=${encodeURIComponent(currentCamMode)}&t=${Date.now()}`;
        addLog("ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº MJPEG-Ğ¿Ğ¾Ñ‚Ğ¾ĞºÑƒ...");

        // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸
        streamImg.onload = null;
        streamImg.onerror = null;

        // Ğ”Ğ°Ñ‘Ğ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ½Ğ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ â€” ĞµÑĞ»Ğ¸ Ğ·Ğ° 15 ÑĞµĞº ĞºĞ°Ğ´Ñ€ Ğ½Ğµ Ğ¿Ñ€Ğ¸ÑˆÑ‘Ğ», Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼
        const loadTimeout = setTimeout(() => {
          if (!streamConnected) {
            addLog("MJPEG: Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸, Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ...", "warn");
            streamStarting = false;
            streamConnected = false;
            scheduleReconnect();
          }
        }, 15000);

        streamImg.onload = function () {
          clearTimeout(loadTimeout);
          if (!streamConnected) {
            streamConnected = true;
            streamStarting = false;
            addLog("MJPEG-Ğ¿Ğ¾Ñ‚Ğ¾Ğº Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½", "ok");
            overlay.classList.add("hidden");
          }
        };

        streamImg.onerror = function () {
          clearTimeout(loadTimeout);
          // ĞĞµ ÑĞ¿Ğ°Ğ¼Ğ¸Ğ¼ Ğ»Ğ¾Ğ³ ĞµÑĞ»Ğ¸ ÑƒĞ¶Ğµ Ğ±Ñ‹Ğ»Ğ¸ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹
          if (streamConnected) {
            addLog("MJPEG-Ğ¿Ğ¾Ñ‚Ğ¾Ğº Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ğ»ÑÑ", "warn");
          }
          streamConnected = false;
          streamStarting = false;
          overlay.classList.remove("hidden");
          scheduleReconnect();
        };

        streamImg.src = url;
      }

      function scheduleReconnect() {
        if (reconnectTimer) return;
        reconnectTimer = setTimeout(() => {
          reconnectTimer = null;
          streamConnected = false;
          startStream();
        }, STREAM_RECONNECT_MS);
      }

      // â”€â”€â”€ ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function takeSnapshot() {
        const a = document.createElement("a");
        a.href = `/snapshot?cam=${encodeURIComponent(currentCamMode)}`;
        a.download = `snapshot_${new Date().toISOString().replace(/[:.]/g, "-")}.jpg`;
        a.click();
        addLog("Ğ¡Ğ½Ğ¸Ğ¼Ğ¾Ğº ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½");
      }

      function toggleFullscreen() {
        const wrap = document.getElementById("streamWrap");
        if (!document.fullscreenElement) {
          wrap.requestFullscreen().catch(() => {});
        } else {
          document.exitFullscreen();
        }
      }

      function toggleLog() {
        logPanel.classList.toggle("open");
      }
      // â”€â”€â”€ Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function setViewMode(mode) {
        const wrap = document.getElementById("streamWrap");
        wrap.className =
          wrap.className.replace(/view-\w+/g, "").trim() + " view-" + mode;
        // ĞÑ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ» Ğ½ÑƒĞ¶ĞµĞ½ overflow: auto Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ĞºÑ€ÑƒÑ‚ĞºĞ¸
        wrap.style.overflow = mode === "original" ? "auto" : "hidden";
        localStorage.setItem("viewMode", mode);
        addLog(
          "Ğ ĞµĞ¶Ğ¸Ğ¼: " +
            {
              fit: "Ğ’Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ (Ñ€Ğ°ÑÑ‚ÑĞ½ÑƒÑ‚ÑŒ)",
              contain: "ĞŸÑ€Ğ¾Ğ¿Ğ¾Ñ€Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾",
              fill: "Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ (Ğ¾Ğ±Ñ€ĞµĞ·ĞºĞ°)",
              original: "ĞÑ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ» 1:1",
            }[mode],
        );
      }

      function setCamMode(mode) {
        currentCamMode = mode || "full";
        localStorage.setItem("camMode", currentCamMode);
        // ĞŸĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾Ñ‚Ğ¾Ğº, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ?cam=...
        streamConnected = false;
        streamStarting = false;
        if (reconnectTimer) {
          clearTimeout(reconnectTimer);
          reconnectTimer = null;
        }
        startStream();
        addLog(
          "ĞšĞ°Ğ´Ñ€: " +
            {
              full: "Ğ’ĞµÑÑŒ ĞºĞ°Ğ´Ñ€",
              top: "Ğ’ĞµÑ€Ñ…",
              bottom: "ĞĞ¸Ğ·",
            }[currentCamMode],
        );
      }

      // Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼
      (function () {
        const saved = localStorage.getItem("viewMode");
        if (saved) {
          document.getElementById("viewMode").value = saved;
          setViewMode(saved);
        }

        const savedCam = localStorage.getItem("camMode");
        if (savedCam) {
          document.getElementById("camMode").value = savedCam;
          currentCamMode = savedCam;
        }
      })();
      // â”€â”€â”€ Ğ¢Ñ€ĞµĞ²Ğ¾Ğ³Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const alarmPanel = document.getElementById("alarmPanel");
      const alarmList = document.getElementById("alarmList");
      const alarmCount = document.getElementById("alarmCount");
      const alarmLastCheck = document.getElementById("alarmLastCheck");
      const alarmModal = document.getElementById("alarmModal");
      const alarmModalImg = document.getElementById("alarmModalImg");
      const alarmModalInfo = document.getElementById("alarmModalInfo");
      let lastAlarmCount = 0;

      function toggleAlarms() {
        alarmPanel.classList.toggle("open");
        if (alarmPanel.classList.contains("open")) {
          loadAlarms();
        }
      }

      async function loadAlarms() {
        try {
          const resp = await fetch("/alarms?limit=50", {
            signal: AbortSignal.timeout(5000),
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();

          alarmCount.textContent = data.total;
          alarmLastCheck.textContent = data.last_check
            ? `ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°: ${new Date(data.last_check).toLocaleTimeString("ru-RU")}`
            : "â€”";

          if (data.alarms.length === 0) {
            alarmList.innerHTML =
              '<li class="alarm-empty">Ğ¢Ñ€ĞµĞ²Ğ¾Ğ³ Ğ½Ğµ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¾</li>';
            return;
          }

          // Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾ÑĞ²Ğ¸Ğ»Ğ¸ÑÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ñ‚Ñ€ĞµĞ²Ğ¾Ğ³Ğ¸ â€” ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼ Ğ² Ğ»Ğ¾Ğ³
          if (data.total > lastAlarmCount && lastAlarmCount > 0) {
            addLog(`ĞĞ¾Ğ²Ñ‹Ñ… Ñ‚Ñ€ĞµĞ²Ğ¾Ğ³: ${data.total - lastAlarmCount}`, "warn");
          }
          lastAlarmCount = data.total;

          alarmList.innerHTML = data.alarms
            .map((a) => {
              const thumbUrl = `/alarm_photo?file=${encodeURIComponent(a.file)}&start=${encodeURIComponent(a.time)}&end=${encodeURIComponent(a.end_time || a.time)}`;
              const hasPhoto = a.photo_file ? "ğŸ“·" : "";
              return `<li class="alarm-item" onclick="showAlarmPhoto('${thumbUrl.replace(/'/g, "\\'")}', '${a.type} â€” ${a.time}')">
              <img class="alarm-thumb" src="${thumbUrl}" loading="lazy" onerror="this.style.display='none'" />
              <div class="alarm-info">
                <div class="alarm-type">ğŸš¨ ${a.type} ${hasPhoto}</div>
                <div class="alarm-time">ğŸ• ${a.time}${a.end_time && a.end_time !== a.time ? " â†’ " + a.end_time : ""}</div>
              </div>
            </li>`;
            })
            .join("");
        } catch (e) {
          alarmList.innerHTML =
            '<li class="alarm-empty">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ‚Ñ€ĞµĞ²Ğ¾Ğ³</li>';
        }
      }

      function showAlarmPhoto(url, info) {
        event && event.stopPropagation();
        alarmModalImg.src = url;
        alarmModalInfo.textContent = info;
        alarmModal.classList.add("show");
      }

      function closeAlarmModal() {
        alarmModal.classList.remove("show");
        // ĞĞ• ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ src="" â€” ÑÑ‚Ğ¾ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° "/"
        // Ğ¸ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑĞ»Ğ¾Ğ¼Ğ°Ñ‚ÑŒ MJPEG Ğ¿Ğ¾Ñ‚Ğ¾Ğº
        alarmModalImg.removeAttribute("src");
        // Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ñ‚Ğ¾Ğº ĞµÑĞ»Ğ¸ Ğ¾Ğ½ Ğ¿Ñ€Ğ¾Ğ¿Ğ°Ğ»
        if (!streamConnected && !streamStarting) {
          startStream();
        }
      }

      // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ñ€ĞµĞ²Ğ¾Ğ³Ğ¸ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 30 ÑĞµĞº ĞµÑĞ»Ğ¸ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ°
      setInterval(() => {
        if (alarmPanel.classList.contains("open")) loadAlarms();
      }, 30000);

      // â”€â”€â”€ Ğ—Ğ°Ğ¿ÑƒÑĞº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      addLog("Stream Viewer Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½");
      pollStatus();
      setInterval(pollStatus, STATUS_POLL_MS);

      // ĞŸĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğµ Ğ½Ğ° Ğ²ĞºĞ»Ğ°Ğ´ĞºÑƒ
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
          addLog("Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ°...");
          pollStatus();
          if (!streamConnected && !streamStarting && !reconnectTimer)
            startStream();
        }
      });
    </script>
  </body>
</html>
